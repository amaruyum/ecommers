<app-navbar />

<main class="detalle-page">

  @if (loading()) {
    <div class="loading-state">
      <span class="spinner"></span>
      <p>Cargando...</p>
    </div>
  }

  @if (errorMsg()) {
    <div class="error-state">
      <p>{{ errorMsg() }}</p>
      <button class="btn-volver" (click)="volver()">← Volver</button>
    </div>
  }

  @if (!loading() && item()) {
    <div class="detalle-inner">

      <!-- Breadcrumb -->
      <div class="breadcrumb">
        <button (click)="volver()">← Volver</button>
        @if (item()?.categoria) {
          <span>{{ item()?.categoria?.nombre }}</span>
        }
        <span class="bc-current">{{ item()?.nombre }}</span>
      </div>

      <div class="detalle-grid">

        <!-- Imagen -->
        <div class="img-col">
          <div class="img-wrap">
            <img [src]="getImagen()" [alt]="item()?.nombre"/>
            <div class="img-badges">
              @if (item()?.categoria) {
                <span class="badge-cat">{{ item()?.categoria?.nombre }}</span>
              }
              <span class="badge-tipo" [class]="'tipo-' + item()?.tipo">
                {{ item()?.tipo === 'producto' ? 'Producto' : 'Servicio' }}
              </span>
            </div>
          </div>

          <!-- Info rápida servicio -->
          @if (isServicio() && item()?.servicio) {
            <div class="quick-info">
              @if (item()?.servicio?.fecha_inicio) {
                <div class="qi-item">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#7C9A7E" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                  <div><span class="qi-label">Inicio</span><span class="qi-val">{{ formatFecha(item()?.servicio?.fecha_inicio ?? null) }}</span></div>
                </div>
              }
              @if (item()?.servicio?.fecha_fin) {
                <div class="qi-item">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#7C9A7E" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                  <div><span class="qi-label">Fin</span><span class="qi-val">{{ formatFecha(item()?.servicio?.fecha_fin ?? null) }}</span></div>
                </div>
              }
              @if (item()?.servicio?.lugar) {
                <div class="qi-item">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#7C9A7E" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
                  <div><span class="qi-label">Lugar</span><span class="qi-val">{{ item()?.servicio?.lugar }}</span></div>
                </div>
              }
              <div class="qi-item">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#7C9A7E" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                <div><span class="qi-label">Duración</span><span class="qi-val">{{ getDuracion() }}</span></div>
              </div>
            </div>
          }
        </div>

        <!-- Info + Compra -->
        <div class="info-col">
          <h1>{{ item()?.nombre }}</h1>
          <p class="descripcion">{{ item()?.descripcion }}</p>

          <!-- Producto: detalles -->
          @if (isProducto() && item()?.producto) {
            <div class="detalles-section">
              <h3>Detalles del Producto</h3>
              <div class="detalles-grid">
                @if (item()?.producto?.marca) {
                  <div class="detalle-row">
                    <span class="det-label">Marca</span>
                    <span class="det-val">{{ item()?.producto?.marca }}</span>
                  </div>
                }
                @if (item()?.producto?.fecha_elaboracion) {
                  <div class="detalle-row">
                    <span class="det-label">Elaboración</span>
                    <span class="det-val">{{ item()?.producto?.fecha_elaboracion }}</span>
                  </div>
                }
                @if (item()?.producto?.fecha_caducidad) {
                  <div class="detalle-row">
                    <span class="det-label">Caducidad</span>
                    <span class="det-val">{{ item()?.producto?.fecha_caducidad }}</span>
                  </div>
                }
                <div class="detalle-row">
                  <span class="det-label">Stock</span>
                  <span class="det-val" [class.stock-bajo]="(item()?.producto?.stock_disponible ?? 0) <= 5">
                    {{ item()?.producto?.stock_disponible ?? 0 }} unidades disponibles
                  </span>
                </div>
              </div>
            </div>
          }

          <!-- Servicio: cupos + itinerario -->
          @if (isServicio() && item()?.servicio) {
            @if (item()?.servicio?.cupos_totales) {
              <div class="cupos-section">
                <div class="cupos-header">
                  <span>Cupos disponibles</span>
                  <strong>{{ item()?.servicio?.cupos_disponibles }} / {{ item()?.servicio?.cupos_totales }}</strong>
                </div>
                <div class="cupos-bar">
                  <div class="cupos-fill" [style.width.%]="getCuposPct()"
                       [class.cupos-bajo]="getCuposPct() <= 25"></div>
                </div>
              </div>
            }

            @if (item()?.servicio?.itinerario) {
              <div class="detalles-section">
                <h3>Itinerario</h3>
                <p class="itinerario-text">{{ item()?.servicio?.itinerario }}</p>
              </div>
            }

            @if (item()?.servicio?.politicas_cancelacion) {
              <div class="detalles-section">
                <h3>Políticas de Cancelación</h3>
                <p class="politicas-text">{{ item()?.servicio?.politicas_cancelacion }}</p>
              </div>
            }
          }

          <!-- Box de compra -->
          <div class="compra-box">
            <div class="precio-wrap">
              <span class="precio-label">Precio</span>
              <span class="precio">${{ item()?.precio | number:'1.2-2' }}</span>
            </div>

            @if (isProducto()) {
              <div class="cantidad-wrap">
                <span class="cantidad-label">Cantidad</span>
                <div class="cantidad-ctrl">
                  <button (click)="decrementar()">−</button>
                  <span>{{ cantidad() }}</span>
                  <button (click)="incrementar()">+</button>
                </div>
              </div>
              <div class="total-wrap">
                <span>Total</span>
                <strong>${{ getTotal() | number:'1.2-2' }}</strong>
              </div>
            }

            <button class="btn-accion"
                    [disabled]="item()?.estado === 'agotado' || item()?.estado === 'inactivo'"
                    (click)="agregarAlCarrito()"
                    [class.en-carrito]="cart.estaEnCarrito(item()?.id_item ?? 0)">
              @if (isProducto()) {
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>
                {{ cart.estaEnCarrito(item()?.id_item ?? 0) ? '✓ Agregado al carrito' : 'Agregar al carrito' }}
              } @else {
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                {{ (item()?.servicio?.cupos_disponibles ?? 0) === 0 ? 'Sin cupos disponibles' : 'Reservar lugar' }}
              }
            </button>

            <p class="estado-nota">
              @if (item()?.estado === 'agotado') { <span class="nota-red">⚠ Este item está agotado</span> }
              @else if (item()?.estado === 'inactivo') { <span class="nota-red">⚠ Este item no está disponible</span> }
              @else { <span class="nota-green">✓ Disponible</span> }
            </p>
          </div>

        </div>
      </div>
    </div>
  }
</main>