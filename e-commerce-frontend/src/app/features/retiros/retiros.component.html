<app-navbar />

<main class="retiros-page">

  <!-- Hero -->
  <section class="hero">
    <div class="hero-overlay"></div>
    <div class="hero-content">
      <h1>Retiros & Eventos de Bienestar</h1>
      <p>Descubre experiencias transformadoras que te ayudarán a reconectar con tu esencia,
         sanar tu cuerpo y renovar tu espíritu en entornos naturales inspiradores.</p>
    </div>
  </section>

  <div class="page-inner">

    <!-- Error -->
    @if (errorMsg()) {
      <div class="alert-error">{{ errorMsg() }}</div>
    }

    <!-- Loading -->
    @if (loading()) {
      <div class="loading-state">
        <span class="spinner"></span>
        <p>Cargando retiros...</p>
      </div>
    }

    @if (!loading() && !errorMsg()) {

      <!-- Buscador -->
      <div class="search-bar">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
             fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
        </svg>
        <input type="text" placeholder="Buscar retiros, lugares, experiencias..."
               (input)="onSearch($event)"/>
      </div>

      <!-- Sin resultados -->
      @if (retiros().length === 0) {
        <div class="empty-state">
          <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24"
               fill="none" stroke="#C8BFB0" stroke-width="1.5">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
          </svg>
          <p>No hay retiros disponibles en este momento.</p>
        </div>
      }

      <!-- Destacados -->
      @if (getDestacados().length > 0) {
        <section class="section">
          <h2 class="section-title">Retiros Destacados</h2>
          <div class="destacados-grid">
            @for (retiro of getDestacados(); track retiro.id_item) {
              <div class="card-destacada">
                <div class="card-img-wrap">
                  <img [src]="getImagen(retiro)" [alt]="retiro.nombre" loading="lazy"/>
                  <span class="badge-destacado">Destacado</span>
                  <button class="btn-fav" (click)="toggleFavorito(retiro.id_item)"
                          [class.active]="esFavorito(retiro.id_item)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                         [attr.fill]="esFavorito(retiro.id_item) ? '#C97B4B' : 'none'"
                         stroke="#C97B4B" stroke-width="2">
                      <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                    </svg>
                  </button>
                </div>
                <div class="card-body">
                  <h3>{{ retiro.nombre }}</h3>
                  <p class="card-desc">{{ retiro.descripcion }}</p>
                  <div class="card-meta">
                    @if (retiro.servicio?.lugar) {
                      <span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
                        {{ retiro.servicio?.lugar }}
                      </span>
                    }
                    @if (retiro.servicio?.fecha_inicio) {
                      <span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                        {{ formatFecha(retiro.servicio?.fecha_inicio ?? null) }}
                      </span>
                    }
                    <span>
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                      {{ getDuracion(retiro) }}
                    </span>
                    @if (retiro.servicio?.cupos_disponibles !== null) {
                      <span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                        Capacidad: {{ retiro.servicio?.cupos_totales }} personas
                      </span>
                    }
                  </div>
                  <div class="card-footer">
                    <div>
                      <span class="precio-label">Desde</span>
                      <span class="precio">${{ retiro.precio | number:'1.2-2' }}</span>
                    </div>
                    <button class="btn-reservar" [routerLink]="['/dashboard/item', retiro.id_item]">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>
                      Reservar Ahora
                    </button>
                  </div>
                </div>
              </div>
            }
          </div>
        </section>
      }

      <!-- Todos los Retiros -->
      @if (getTodos().length > 0) {
        <section class="section">
          <h2 class="section-title">Todos los Retiros</h2>
          <div class="todos-grid">
            @for (retiro of getTodos(); track retiro.id_item) {
              <div class="card-small">
                <div class="card-img-sm">
                  <img [src]="getImagen(retiro)" [alt]="retiro.nombre" loading="lazy"/>
                  <span class="badge-nivel">{{ getNivelLabel(retiro) }}</span>
                  <button class="btn-fav btn-fav-sm" (click)="toggleFavorito(retiro.id_item)"
                          [class.active]="esFavorito(retiro.id_item)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                         [attr.fill]="esFavorito(retiro.id_item) ? '#C97B4B' : 'none'"
                         stroke="#C97B4B" stroke-width="2">
                      <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                    </svg>
                  </button>
                </div>
                <div class="card-body-sm">
                  <h3 class="card-titulo-sm">{{ retiro.nombre }}</h3>
                  <p class="card-desc-sm">{{ retiro.descripcion }}</p>
                  <div class="card-meta-sm">
                    @if (retiro.servicio?.lugar) {
                      <span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
                        {{ retiro.servicio?.lugar }}
                      </span>
                    }
                    @if (retiro.servicio?.fecha_inicio) {
                      <span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                        {{ formatFecha(retiro.servicio?.fecha_inicio ?? null) }}
                      </span>
                    }
                  </div>
                  <div class="card-footer-sm">
                    <span class="precio">${{ retiro.precio | number:'1.2-2' }}</span>
                    <button class="btn-detalles" [routerLink]="['/dashboard/item', retiro.id_item]">Ver Detalles</button>
                  </div>
                </div>
              </div>
            }
          </div>
        </section>
      }

    }
  </div>
</main>